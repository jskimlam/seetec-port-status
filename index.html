<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš¢ ëŒ€ì‚°í•­ Seetec í¬íŠ¸ í˜„í™©íŒ (M.D.C.)</title>
    <style>
        :root { 
            --bg: #f4f7f6; --open: #2ecc71; --closed: #e74c3c; --heavy-closed: #941a1a; 
            --none: #dfe6e9; --text: #2d3436; --fix: #f39c12; --mateo: #3498db;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: var(--text); }
        .container { max-width: 800px; margin: 0 auto; background: #fff; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; }
        
        /* ë””ìì¸ ë³µêµ¬: ì§„ì²­ìƒ‰ í—¤ë” ìŠ¤íƒ€ì¼ */
        .header { background: #34495e; color: #fff; padding: 25px 20px; text-align: center; position: relative; }
        .header h2 { margin: 0; font-size: 1.5rem; letter-spacing: -0.5px; }
        .created-by { font-size: 0.85rem; color: #bdc3c7; margin-top: 8px; font-weight: 500; }
        
        .conn-status { position: absolute; top: 10px; right: 15px; font-size: 0.7rem; padding: 4px 8px; border-radius: 20px; background: rgba(0,0,0,0.3); }
        .conn-status.online { border: 1px solid var(--open); color: var(--open); }
        .conn-status.realtime { border: 1px solid var(--mateo); color: var(--mateo); right: auto; left: 15px; }

        .month-nav { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; padding: 15px; background: #f8f9fa; }
        .m-btn { border: 1px solid #ddd; background: #fff; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }
        .m-btn.active { background: #3498db; color: #fff; border-color: #3498db; }
        
        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); background: #fff; padding: 15px 5px; border-bottom: 2px solid #f1f2f6; }
        .stat-item { text-align: center; border-right: 1px solid #eee; }
        .stat-label { font-size: 0.75rem; color: #636e72; font-weight: bold; display: block; margin-bottom: 5px; }
        .stat-val { font-size: 1.1rem; font-weight: 800; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .weekday { background: #f1f2f6; text-align: center; padding: 10px 0; font-size: 0.8rem; font-weight: bold; border-bottom: 1px solid #eee; }
        .day-cell { border-right: 1px solid #eee; border-bottom: 1px solid #eee; min-height: 105px; position: relative; background: #fff; }
        .day-num { font-size: 0.75rem; font-weight: bold; padding: 5px; color: #636e72; }
        
        .slot-container { display: flex; flex-direction: column; height: 75px; gap: 2px; padding: 2px; }
        .slot { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; border-radius: 4px; font-weight: bold; cursor: pointer; border: 1px solid transparent; }
        .slot.open { background: var(--open); color: #fff; }
        .slot.closed { background: var(--closed); color: #fff; }
        .slot.heavy-closed { background: var(--heavy-closed); color: #fff; }
        .slot.mateo-badge { border: 1.5px solid #fff; box-shadow: inset 0 0 5px rgba(0,0,0,0.1); }
        .slot.none { background: var(--none); color: #999; }

        .footer { padding: 20px; text-align: center; font-size: 0.75rem; color: #bdc3c7; border-top: 1px solid #eee; }
        
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 25px; border-radius: 15px; width: 85%; max-width: 320px; text-align: center; }
        .wave-detail-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 1px solid #eee; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div id="mateoBadge" class="conn-status realtime">Mateo í†µì‹  ëŒ€ê¸°</div>
        <div id="connBadge" class="conn-status online">ì‹œíŠ¸ ì—°ê²° í™•ì¸ ì¤‘</div>
        <h2>ğŸš¢ ëŒ€ì‚°í•­ Seetec í˜„í™©íŒ</h2>
        <div class="created-by">Created by JS KIM (LAM) | M+17 Peak Hold</div>
    </div>

    <div class="month-nav" id="monthNav"></div>
    <div class="stats-bar">
        <div class="stat-item"><span class="stat-label">ğŸŸ¢ ì˜¤í”ˆìœ¨</span><span id="openRatio" class="stat-val" style="color:var(--open)">0%</span></div>
        <div class="stat-item"><span class="stat-label">ğŸ”´ í´ë¡œì§•</span><span id="closedCount" class="stat-val" style="color:var(--closed)">0</span></div>
        <div class="stat-item"><span class="stat-label">ğŸš« ë¹„ìœ¨</span><span id="closedRatio" class="stat-val" style="color:var(--closed)">0%</span></div>
    </div>

    <div class="calendar-grid" id="calendar">
        <div class="weekday">ì¼</div><div class="weekday">ì›”</div><div class="weekday">í™”</div><div class="weekday">ìˆ˜</div><div class="weekday">ëª©</div><div class="weekday">ê¸ˆ</div><div class="weekday">í† </div>
    </div>
    <div class="footer">Â© 2026 LAM. Hybrid Data Monitoring System.</div>
</div>

<div id="modal" onclick="closeModal()"><div class="modal-content" onclick="event.stopPropagation()">
    <div id="mDate" style="font-weight:bold; margin-bottom:5px; color:#7f8c8d; font-size:0.9rem;"></div>
    <div id="mStatus" style="font-weight:bold; font-size:1.4rem; margin-bottom:15px;"></div>
    <div class="wave-detail-box">
        <div><div style="font-size:0.7rem; color:#999;">ìµœì € íŒŒê³ </div><div id="mLow" style="font-size:1.1rem; font-weight:800;">-</div></div>
        <div><div style="font-size:0.7rem; color:#999;">ìµœê³  í”¼í¬</div><div id="mHigh" style="font-size:1.1rem; font-weight:800;">-</div></div>
    </div>
    <button onclick="closeModal()" style="padding:10px 25px; border-radius:5px; border:1px solid #ddd; cursor:pointer; font-weight:bold; margin-top:15px;">ë‹«ê¸°</button>
</div></div>

<script>
    const year = 2026;
    let currentMonth = new Date().getMonth() + 1;
    let globalData = {};
    const sheetCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGrqzEdgECvgskv4CW-1-FdlAXq1ZIYomFapbQidCM8i2avijanfPHgOKk8Ajtyrt8a6VqbSvpT6uN/pub?output=csv";

    // 1. ì´ˆê¸°í™” ì‹¤í–‰
    async function init() {
        renderNav();
        
        // ë¡œì»¬ ì €ì¥ì†Œ Peak ë°ì´í„° ë³µêµ¬
        const saved = localStorage.getItem('daesan_peak_hold');
        if (saved) globalData = JSON.parse(saved);

        await syncWithGoogleSheets();
        await refreshMateoRealtime();
    }

    // 2. êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™ (M ~ M+9)
    async function syncWithGoogleSheets() {
        const badge = document.getElementById('connBadge');
        try {
            const res = await fetch(sheetCsvUrl);
            const csv = await res.text();
            const lines = csv.split('\n').slice(1);
            
            lines.forEach(line => {
                const cols = line.split(',');
                if (cols.length >= 5) {
                    const ds = cols[0].trim();
                    const rowDate = new Date(ds); rowDate.setHours(0,0,0,0);
                    const mPlus10 = new Date(); mPlus10.setHours(0,0,0,0); mPlus10.setDate(mPlus10.getDate() + 10);

                    // M+10ì¼ ì´ì „ ë°ì´í„°ë§Œ ì‹œíŠ¸ ì •ë³´ë¡œ ìˆ˜ìš©
                    if (rowDate < mPlus10) {
                        if (!globalData[ds]) globalData[ds] = [{}, {}];
                        // Mateo ë°ì´í„°ê°€ ìˆë‹¤ë©´ ë®ì–´ì“°ì§€ ì•ŠìŒ (ì‹œíŠ¸ ìš°ì„ )
                        const isAM = cols[1].includes("ì˜¤ì „");
                        const idx = isAM ? 0 : 1;
                        globalData[ds][idx] = { t: cols[1], low: cols[2], high: cols[3], s: cols[4].trim() };
                    }
                }
            });
            badge.innerText = "â— ì‹œíŠ¸ ì—°ë™ ì„±ê³µ"; badge.className = "conn-status online";
            renderCalendar(currentMonth);
        } catch (e) {
            badge.innerText = "â— ì‹œíŠ¸ ì—°ê²° ì‹¤íŒ¨";
        }
    }

    // 3. Mateo API ì—°ë™ (M+10 ~ M+17) - Peak Hold í¬í•¨
    async function refreshMateoRealtime() {
        const mBadge = document.getElementById('mateoBadge');
        const lat = 37.0, lon = 125.5;
        const url = `https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lon}&hourly=wave_height&timezone=Asia/Seoul&forecast_days=17`;
        
        const today = new Date(); today.setHours(0,0,0,0);
        const mPlus10 = new Date(today); mPlus10.setDate(today.getDate() + 10);

        try {
            const res = await fetch(url);
            const json = await res.json();
            if (!json.hourly) throw new Error("API Data Empty");

            const waves = json.hourly.wave_height;
            const times = json.hourly.time;

            // 17ì¼ì¹˜ ì „ì²´ íƒìƒ‰
            for (let d = 0; d < 18; d++) {
                const idx = d * 24;
                if (idx >= waves.length) break;

                const ds = times[idx].split('T')[0];
                const rowDate = new Date(ds); rowDate.setHours(0,0,0,0);

                // M+10ì¼ ì´í›„ë¶€í„°ë§Œ Mateo ë°ì´í„° ì ìš©
                if (rowDate >= mPlus10) {
                    const dayWaves = waves.slice(idx, idx + 24);
                    const am = dayWaves.slice(0, 12);
                    const pm = dayWaves.slice(12, 24);
                    const amMax = Math.max(...am).toFixed(1);
                    const pmMax = Math.max(...pm).toFixed(1);

                    if (!globalData[ds] || !Array.isArray(globalData[ds])) globalData[ds] = [{}, {}];

                    // Peak Hold ë¡œì§: ê¸°ì¡´ ê°’ë³´ë‹¤ í´ ë•Œë§Œ ì—…ë°ì´íŠ¸
                    const oldAm = parseFloat(globalData[ds][0]?.high || 0);
                    if (parseFloat(amMax) >= oldAm) {
                        globalData[ds][0] = { t: "ì˜¤ì „(Mateo)", low: Math.min(...am).toFixed(1), high: amMax, s: parseFloat(amMax) > 2.0 ? "Closed" : "Open" };
                    }
                    const oldPm = parseFloat(globalData[ds][1]?.high || 0);
                    if (parseFloat(pmMax) >= oldPm) {
                        globalData[ds][1] = { t: "ì˜¤í›„(Mateo)", low: Math.min(...pm).toFixed(1), high: pmMax, s: parseFloat(pmMax) > 2.0 ? "Closed" : "Open" };
                    }
                }
            }
            localStorage.setItem('daesan_peak_hold', JSON.stringify(globalData));
            mBadge.innerText = "â— Mateo ì‹¤ì‹œê°„ ë°˜ì˜ë¨";
            renderCalendar(currentMonth);
        } catch (e) {
            mBadge.innerText = "â— Mateo ì—°ë™ ì§€ì—°";
            console.error("Mateo Error:", e);
        }
    }

    // 4. ë‹¬ë ¥ ë Œë”ë§ í•¨ìˆ˜
    function renderCalendar(month) {
        const grid = document.getElementById('calendar');
        grid.querySelectorAll('.day-cell').forEach(c => c.remove());
        const firstDay = new Date(year, month - 1, 1).getDay();
        const daysInMonth = new Date(year, month, 0).getDate();
        let t = 0, o = 0, c = 0;

        for (let i = 0; i < firstDay; i++) {
            const e = document.createElement('div'); e.className = 'day-cell'; e.style.background = '#f9f9f9'; grid.appendChild(e);
        }

        for (let d = 1; d <= daysInMonth; d++) {
            const ds = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const records = globalData[ds] || [];
            
            const cell = document.createElement('div'); cell.className = 'day-cell';
            cell.innerHTML = `<div class="day-num">${d}</div>`;
            const container = document.createElement('div'); container.className = 'slot-container';

            [{k:"ì˜¤ì „", l:"AM"}, {k:"ì˜¤í›„", l:"PM"}].forEach((p, i) => {
                const r = records[i];
                const slot = document.createElement('div');
                if (r && r.t) {
                    const st = r.s.trim().toLowerCase();
                    const hv = parseFloat(r.high);
                    if (!isNaN(hv)) { t++; if (st === "closed") c++; else o++; }
                    
                    let sClass = (st === 'closed') ? (hv >= 4.0 ? 'heavy-closed' : 'closed') : (st === 'open' ? 'open' : 'none');
                    slot.className = `slot ${sClass} ${r.t.includes("Mateo") ? 'mateo-badge' : ''}`;
                    slot.innerHTML = (st === 'closed' ? 'ğŸ”´' : (st === 'open' ? 'ğŸŸ¢' : 'â³')) + " " + p.l;
                    slot.onclick = () => showDetail(ds, r.t, r.low, r.high, r.s);
                } else {
                    slot.className = 'slot none'; slot.innerText = '---';
                }
                container.appendChild(slot);
            });
            cell.appendChild(container); grid.appendChild(cell);
        }
        updateStats(t, o, c);
    }

    function updateStats(t, o, c) {
        const ratio = t > 0 ? Math.round((o / t) * 100) : 0;
        document.getElementById('openRatio').innerText = ratio + "%";
        document.getElementById('closedCount').innerText = c;
        document.getElementById('closedRatio').innerText = (t > 0 ? (100 - ratio) : 0) + "%";
    }

    function showDetail(d, t, low, high, s) {
        document.getElementById('mDate').innerText = `${d} [${t}]`;
        const hv = parseFloat(high);
        const mS = document.getElementById('mStatus');
        const isC = s.toLowerCase() === 'closed';
        mS.innerText = isC ? (hv >= 4.0 ? 'ğŸš¨ HEAVY CLOSED' : 'ğŸ”´ PORT CLOSED') : 'ğŸŸ¢ PORT OPEN';
        mS.style.color = isC ? (hv >= 4.0 ? '#941a1a' : '#e74c3c') : '#2ecc71';
        document.getElementById('mLow').innerText = low + "m";
        document.getElementById('mHigh').innerText = high + "m";
        document.getElementById('modal').style.display = 'flex';
    }

    function renderNav() {
        const nav = document.getElementById('monthNav'); nav.innerHTML = '';
        for (let m = 1; m <= 12; m++) {
            const btn = document.createElement('button');
            btn.className = `m-btn ${m === currentMonth ? 'active' : ''}`; btn.innerText = m + 'ì›”';
            btn.onclick = () => { currentMonth = m; document.querySelectorAll('.m-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderCalendar(m); };
            nav.appendChild(btn);
        }
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    window.onload = init;
</script>
</body>
</html>
