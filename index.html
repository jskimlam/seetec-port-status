<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš¢ ëŒ€ì‚°í•­ Seetec í¬íŠ¸ í˜„í™©íŒ (M.D.C.)</title>
    <style>
        :root { 
            --bg: #f4f7f6; 
            --open: #2ecc71; 
            --closed: #e74c3c; 
            --heavy-closed: #941a1a; /* 4m ì´ìƒ: ì§„í•œ ë¹¨ê°• */
            --none: #dfe6e9; 
            --text: #2d3436; 
            --fix: #f39c12; 
            --mateo: #3498db;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: var(--text); }
        .container { max-width: 800px; margin: 0 auto; background: #fff; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; }
        
        .header { background: #34495e; color: #fff; padding: 25px 20px; text-align: center; position: relative; }
        .header h2 { margin: 0; font-size: 1.5rem; }
        .created-by { font-size: 0.85rem; color: #bdc3c7; margin-top: 8px; font-weight: 500; letter-spacing: 0.5px; }
        
        .conn-status { position: absolute; top: 10px; right: 15px; font-size: 0.7rem; padding: 4px 8px; border-radius: 20px; background: rgba(0,0,0,0.3); }
        .conn-status.online { border: 1px solid var(--open); color: var(--open); }
        .conn-status.fix { border: 1px solid var(--fix); color: var(--fix); }
        .conn-status.realtime { border: 1px solid var(--mateo); color: var(--mateo); right: auto; left: 15px; }

        .fix-panel { background: #fff9e6; padding: 15px; border-bottom: 2px solid #ffeaa7; display: none; text-align: center; }
        .fix-panel.active { display: block !important; }
        
        #authArea { display: none; margin-top: 10px; }
        #dataInputArea { display: none; margin-top: 15px; border-top: 1px dashed #f39c12; padding-top: 15px; }
        textarea { width: 90%; height: 120px; font-size: 0.7rem; border-radius: 5px; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; }
        input[type="password"] { padding: 10px; border-radius: 5px; border: 1px solid #ddd; width: 180px; margin-bottom: 5px; }
        .btn-main { padding: 10px 20px; background:#34495e; color:#fff; border:none; border-radius:5px; cursor:pointer; font-weight:bold; }
        .btn-apply { padding: 10px 25px; background:var(--open); color:#fff; border:none; border-radius:5px; cursor:pointer; font-weight:bold; }

        .month-nav { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; padding: 15px; background: #f8f9fa; }
        .m-btn { border: 1px solid #ddd; background: #fff; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }
        .m-btn.active { background: #3498db; color: #fff; border-color: #3498db; }

        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); background: #fff; padding: 15px 5px; border-bottom: 2px solid #f1f2f6; }
        .stat-item { text-align: center; border-right: 1px solid #eee; }
        .stat-item:last-child { border-right: none; }
        .stat-label { font-size: 0.75rem; color: #636e72; font-weight: bold; display: block; margin-bottom: 5px; }
        .stat-val { font-size: 1.1rem; font-weight: 800; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .weekday { background: #f1f2f6; text-align: center; padding: 10px 0; font-size: 0.8rem; font-weight: bold; border-bottom: 1px solid #eee; }
        .day-cell { border-right: 1px solid #eee; border-bottom: 1px solid #eee; min-height: 95px; position: relative; background: #fff; }
        .day-num { font-size: 0.75rem; font-weight: bold; padding: 5px; color: #636e72; }
        
        .slot-container { display: flex; flex-direction: column; height: 70px; gap: 2px; padding: 2px; }
        .slot { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; border-radius: 3px; font-weight: bold; cursor: pointer; }
        .slot.none { background: var(--none); color: #999; }
        .slot.open { background: var(--open); color: #fff; }
        .slot.closed { background: var(--closed); color: #fff; }
        .slot.heavy-closed { background: var(--heavy-closed); color: #fff; text-shadow: 0 0 3px rgba(0,0,0,0.5); }
        .slot.mateo-badge { border: 1.5px solid #fff; box-shadow: inset 0 0 5px rgba(0,0,0,0.1); }

        .footer { padding: 15px; text-align: center; font-size: 0.75rem; color: #bdc3c7; border-top: 1px solid #eee; }
        
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 25px; border-radius: 15px; text-align: center; width: 85%; max-width: 300px; }
        .wave-detail-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 1px solid #eee; }
        .wave-label { font-size: 0.75rem; color: #7f8c8d; margin-bottom: 5px; }
        .wave-value { font-size: 1.1rem; font-weight: 800; color: #2d3436; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div id="mateoBadge" class="conn-status realtime">Mateo ì‹¤ì‹œê°„ ëŒ€ê¸°</div>
        <div id="connBadge" class="conn-status">ì—°ê²° í™•ì¸ ì¤‘...</div>
        <h2>ğŸš¢ ëŒ€ì‚°í•­ Seetec í˜„í™©íŒ</h2>
        <div class="created-by">Created by JS KIM (LAM)</div>
        <button onclick="manualToggleFix()" style="background:var(--fix); color:#fff; border:none; padding:6px 12px; border-radius:5px; font-size:0.7rem; cursor:pointer; font-weight:bold; margin-top:15px;">í”½ìŠ¤ëª¨ë“œ ë©”ë‰´ ì„¤ì •</button>
    </div>

    <div id="fixPanel" class="fix-panel">
        <div id="msgArea">
            <strong style="color:var(--fix)">âš ï¸ ë¡œì»¬ ë°ì´í„°/ë³´ì•ˆ ëª¨ë“œ</strong><br>
            <p style="font-size:0.8rem; margin:10px 0;">ê³¼ê±° ì‹¤ì  ìˆ˜ì •ì´ë‚˜ ìˆ˜ë™ ë°ì´í„° ì…ë ¥ ì‹œ ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>
            <button id="btnUnlock" onclick="showAuth()" class="btn-main">ğŸ” ë°ì´í„° ìˆ˜ì •/ì¸ì¦</button>
        </div>
        <div id="authArea">
            <input type="password" id="adminPw" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸">
            <button onclick="checkAuth()" class="btn-main">ì¸ì¦</button>
        </div>
        <div id="dataInputArea">
            <strong>âœ… ì¸ì¦ ì™„ë£Œ: CSV/Tab ë°ì´í„° ë¶™ì—¬ë„£ê¸°</strong><br>
            <textarea id="manualData" placeholder="ë‚ ì§œ	ì‹œê°„	Low	High	Status í˜•ì‹..."></textarea>
            <button onclick="applyManualData()" class="btn-apply">ì €ì¥ ë° ë°˜ì˜</button>
        </div>
    </div>

    <div class="month-nav" id="monthNav"></div>
    
    <div class="stats-bar">
        <div class="stat-item"><span class="stat-label">ğŸŸ¢ ì˜¤í”ˆìœ¨</span><span id="openRatio" class="stat-val" style="color:var(--open)">0%</span></div>
        <div class="stat-item"><span class="stat-label">ğŸ”´ í´ë¡œì§• íšŸìˆ˜</span><span id="closedCount" class="stat-val" style="color:var(--closed)">0íšŒ</span></div>
        <div class="stat-item"><span class="stat-label">ğŸš« í´ë¡œì§• ë¹„ìœ¨</span><span id="closedRatio" class="stat-val" style="color:var(--closed)">0%</span></div>
    </div>

    <div class="calendar-grid" id="calendar">
        <div class="weekday">ì¼</div><div class="weekday">ì›”</div><div class="weekday">í™”</div>
        <div class="weekday">ìˆ˜</div><div class="weekday">ëª©</div><div class="weekday">ê¸ˆ</div><div class="weekday">í† </div>
    </div>

    <div class="footer">Â© 2026 LAM. Real-time data powered by Open-Meteo API.</div>
</div>

<div id="modal" onclick="closeModal()"><div class="modal-content" onclick="event.stopPropagation()">
    <div id="mDate" style="font-weight:bold; margin-bottom:10px; color:#7f8c8d;"></div>
    <div id="mStatus" style="font-weight:bold; font-size:1.3rem;"></div>
    <div class="wave-detail-box" id="waveBox">
        <div><div class="wave-label">ìµœì € íŒŒê³ (Min)</div><div id="mLow" class="wave-value">-</div></div>
        <div><div class="wave-label">ìµœê³  íŒŒê³ (Max)</div><div id="mHigh" class="wave-value">-</div></div>
    </div>
    <button onclick="closeModal()" style="padding:10px 25px; border-radius:5px; border:1px solid #ddd; cursor:pointer;">ì°½ ë‹«ê¸°</button>
</div></div>

<script>
    const year = 2026;
    let currentMonth = new Date().getMonth() + 1;
    let globalData = {};
    const MASTER_PW = "jskim0111";
    // ì‚¬ìš©ìë‹˜ì˜ ì‹¤ì œ êµ¬ê¸€ ì‹œíŠ¸ CSV ì£¼ì†Œ
    const sheetCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGrqzEdgECvgskv4CW-1-FdlAXq1ZIYomFapbQidCM8i2avijanfPHgOKk8Ajtyrt8a6VqbSvpT6uN/pub?output=csv";

    async function init() {
        renderNav();
        const savedData = localStorage.getItem('daesan_fix_data');
        if (savedData) processDataText(savedData);
        
        await syncWithGoogleSheets(); // 1. ê³¼ê±° ì‹¤ì /ê¸°ë³¸ ë°ì´í„° ë¡œë“œ
        await refreshMateoRealtime(); // 2. ì˜¤ëŠ˜~ë¯¸ë˜ ì‹¤ì‹œê°„ Mateo ë°ì´í„° ë®ì–´ì“°ê¸°
    }

    function renderNav() {
        const nav = document.getElementById('monthNav');
        nav.innerHTML = '';
        for(let m=1; m<=12; m++) {
            const btn = document.createElement('button');
            btn.className = `m-btn ${m === currentMonth ? 'active' : ''}`;
            btn.innerText = `${m}ì›”`;
            btn.onclick = () => {
                document.querySelectorAll('.m-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMonth = m;
                renderCalendar(m);
            };
            nav.appendChild(btn);
        }
    }

    async function syncWithGoogleSheets() {
        const badge = document.getElementById('connBadge');
        try {
            const response = await fetch(sheetCsvUrl);
            const csvText = await response.text();
            parseCsvData(csvText);
            badge.innerText = "â— ì‹œíŠ¸ ì—°ê²°ë¨";
            badge.className = "conn-status online";
        } catch (error) {
            badge.innerText = "â— ë¡œì»¬ ëª¨ë“œ";
            badge.className = "conn-status fix";
        }
        renderCalendar(currentMonth);
    }

    // [í•µì‹¬] Open-Meteo ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì§‘ ë° ì˜¤ì „/ì˜¤í›„ ë¶„í•  ë¡œì§
    async function refreshMateoRealtime() {
        const mBadge = document.getElementById('mateoBadge');
        const lat = 37.0, lon = 125.5;
        const url = `https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lon}&hourly=wave_height&timezone=Asia/Seoul&forecast_days=8`;

        try {
            const response = await fetch(url);
            const json = await response.json();
            const hourlyWaves = json.hourly.wave_height;
            const hourlyTime = json.hourly.time;

            // 24ì‹œê°„ ë‹¨ìœ„ë¡œ ë£¨í”„ (0~7ì¼)
            for (let d = 0; d < 8; d++) {
                const dayIndex = d * 24;
                const dateStr = hourlyTime[dayIndex].split('T')[0];
                const dayWaves = hourlyWaves.slice(dayIndex, dayIndex + 24);
                
                if (dayWaves.length === 24) {
                    const amWaves = dayWaves.slice(0, 12);
                    const pmWaves = dayWaves.slice(12, 24);
                    
                    const amMax = Math.max(...amWaves);
                    const pmMax = Math.max(...pmWaves);

                    // ê¸°ì¡´ ì‹¤ì  ë°ì´í„°ë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•´ ì˜¤ëŠ˜ ë‚ ì§œ ì´í›„ë§Œ ë®ì–´ì“°ê±°ë‚˜, 
                    // 'ì‹¤ì‹œê°„' íƒœê·¸ë¥¼ ë¶™ì—¬ globalDataì— ì‚½ì…
                    globalData[dateStr] = [
                        { t: "ì˜¤ì „(Mateoì‹¤ì‹œê°„)", low: Math.min(...amWaves).toFixed(1), high: amMax.toFixed(1), s: amMax > 2.0 ? "Closed" : "Open" },
                        { t: "ì˜¤í›„(Mateoì‹¤ì‹œê°„)", low: Math.min(...pmWaves).toFixed(1), high: pmMax.toFixed(1), s: pmMax > 2.0 ? "Closed" : "Open" }
                    ];
                }
            }
            mBadge.innerText = "â— Mateo ì‹¤ì‹œê°„ ë°˜ì˜ë¨";
            mBadge.style.color = "var(--mateo)";
            renderCalendar(currentMonth);
        } catch (e) {
            mBadge.innerText = "â— Mateo ì—°ê²° ì‹¤íŒ¨";
            console.error(e);
        }
    }

    function parseCsvData(csv) {
        const lines = csv.split('\n');
        lines.forEach((line, i) => {
            if(i === 0) return;
            const cols = line.split(',');
            if(cols.length >= 5) {
                const date = cols[0].trim();
                if(!globalData[date]) globalData[date] = [];
                // Mateo ì‹¤ì‹œê°„ ë°ì´í„°ê°€ ì´ë¯¸ ìˆë‹¤ë©´(ì˜¤ëŠ˜ ì´í›„) ì‹œíŠ¸ ë°ì´í„°ë³´ë‹¤ ìš°ì„ í•¨
                if(!globalData[date].some(r => r.t.includes("ì‹¤ì‹œê°„"))) {
                    globalData[date].push({ t: cols[1], low: cols[2], high: cols[3], s: cols[4].trim() });
                }
            }
        });
    }

    function processDataText(text) {
        const rows = text.trim().split('\n');
        rows.forEach(row => {
            const cols = row.split(/\t|,/); // íƒ­ ë˜ëŠ” ì½¤ë§ˆ í—ˆìš©
            if (cols.length >= 4) {
                const date = cols[0].trim();
                if (!globalData[date]) globalData[date] = [];
                globalData[date].push({ t: cols[1], low: cols[2], high: cols[3], s: cols[4] ? cols[4].trim() : (parseFloat(cols[3]) > 2.0 ? "Closed" : "Open") });
            }
        });
    }

    function renderCalendar(month) {
        const grid = document.getElementById('calendar');
        grid.querySelectorAll('.day-cell').forEach(c => c.remove());
        const firstDay = new Date(year, month - 1, 1).getDay();
        const daysInMonth = new Date(year, month, 0).getDate();
        let total = 0, open = 0, closed = 0;

        for(let i=0; i<firstDay; i++) {
            const empty = document.createElement('div');
            empty.className = 'day-cell';
            empty.style.background = '#f9f9f9';
            grid.appendChild(empty);
        }

        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const records = globalData[dateStr] || [];
            
            const cell = document.createElement('div');
            cell.className = 'day-cell';
            
            const dayNum = document.createElement('div');
            dayNum.className = 'day-num';
            dayNum.innerText = d;
            cell.appendChild(dayNum);

            const slotContainer = document.createElement('div');
            slotContainer.className = 'slot-container';

            [{k:"ì˜¤ì „", l:"AM"}, {k:"ì˜¤í›„", l:"PM"}].forEach(p => {
                const record = records.find(r => r.t.includes(p.k));
                const slot = document.createElement('div');
                
                if(record) {
                    const status = record.s.trim().toLowerCase();
                    const highVal = parseFloat(record.high);
                    const isMateo = record.t.includes("Mateo");
                    const isWaiting = status === "ë°œí‘œëŒ€ê¸°ì¤‘" || isNaN(highVal);
                    
                    if(!isWaiting) {
                        total++;
                        if(status === "closed") closed++; else open++;
                    }

                    let sClass = 'none';
                    if(!isWaiting) {
                        if(status === 'closed') {
                            sClass = (highVal >= 4.0) ? 'heavy-closed' : 'closed';
                        } else {
                            sClass = 'open';
                        }
                    }

                    slot.className = `slot ${sClass} ${isMateo ? 'mateo-badge' : ''}`;
                    slot.innerHTML = `${isWaiting ? 'â³' : (status === 'closed' ? 'ğŸ”´' : 'ğŸŸ¢')} ${p.l}`;
                    slot.onclick = () => showDetail(dateStr, record.t, record.low, record.high, record.s);
                } else {
                    slot.className = 'slot none';
                    slot.innerText = '---';
                }
                slotContainer.appendChild(slot);
            });
            
            cell.appendChild(slotContainer);
            grid.appendChild(cell);
        }
        updateStats(total, open, closed);
    }

    function updateStats(t, o, c) {
        const ratio = t > 0 ? Math.round((o / t) * 100) : 0;
        document.getElementById('openRatio').innerText = ratio + "%";
        document.getElementById('closedCount').innerText = c + "íšŒ";
        document.getElementById('closedRatio').innerText = (t > 0 ? (100 - ratio) : 0) + "%";
    }

    function showDetail(d, t, low, high, s) {
        document.getElementById('mDate').innerText = `${d} [${t}]`;
        const status = s.trim().toLowerCase();
        const highVal = parseFloat(high);
        const isWaiting = status === "ë°œí‘œëŒ€ê¸°ì¤‘" || isNaN(highVal);
        
        const mStatus = document.getElementById('mStatus');
        if (isWaiting) {
            mStatus.innerText = 'â³ ì˜ˆë³´ ëŒ€ê¸° ì¤‘';
            mStatus.style.color = '#7f8c8d';
            document.getElementById('mLow').innerText = "-";
            document.getElementById('mHigh').innerText = "-";
        } else {
            const isClosed = status === 'closed';
            const isHeavy = highVal >= 4.0;
            mStatus.innerText = isClosed ? (isHeavy ? 'ğŸš¨ HEAVY CLOSED' : 'ğŸ”´ PORT CLOSED') : 'ğŸŸ¢ PORT OPEN';
            mStatus.style.color = isClosed ? (isHeavy ? '#941a1a' : '#e74c3c') : '#2ecc71';
            document.getElementById('mLow').innerText = low + "m";
            document.getElementById('mHigh').innerText = high + "m";
        }
        document.getElementById('modal').style.display = 'flex';
    }

    // í”½ìŠ¤ëª¨ë“œ ë° ì¸ì¦ ë¡œì§
    function applyManualData() {
        const input = document.getElementById('manualData').value;
        if(!input) return;
        localStorage.setItem('daesan_fix_data', input);
        processDataText(input);
        renderCalendar(currentMonth);
        alert("ë°ì´í„°ê°€ ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        document.getElementById('dataInputArea').style.display = 'none';
        document.getElementById('msgArea').style.display = 'block';
    }

    function showAuth() { document.getElementById('msgArea').style.display = 'none'; document.getElementById('authArea').style.display = 'block'; }
    function checkAuth() { if (document.getElementById('adminPw').value === MASTER_PW) { document.getElementById('authArea').style.display = 'none'; document.getElementById('dataInputArea').style.display = 'block'; } else { alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜"); } }
    function manualToggleFix() { document.getElementById('fixPanel').classList.toggle('active'); }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    window.onload = init;
</script>
</body>
</html>
